# 04.02 数据库模块开发

### 1. **数据库设计**  

#### 1.1 功能需求

##### 1.1.1 邮件信息存储

- **支持的字段**：
  - 邮件 ID：使用 `UUID` 格式，确保全局唯一性。
  - 发件人地址（Sender）：存储发件人邮件地址。
  - 收件人列表（Recipients）：存储收件人信息，支持多个收件人（JSON 格式）。
  - 抄送列表（CC）：支持存储抄送信息（JSON 格式）。
  - 密件抄送列表（BCC）：支持存储密件抄送信息（JSON 格式）。
  - 邮件主题（Subject）：存储邮件标题。
  - 邮件正文：
    - 纯文本内容（Text Content）
    - HTML 格式内容（HTML Content）
  - 邮件标签（Tags）：存储邮件的分类或关键词（JSON 格式）。
  - 邮件头信息（Headers）：以 JSON 格式存储完整邮件头。
  - 邮件发送时间（Sent At）：存储邮件的发送时间。
  - 创建时间（Created At）：记录邮件在系统中的存储时间。
  - 更新时间（Updated At）：记录最近一次更新邮件信息的时间。

##### 1.1.2 附件管理

- **功能**：
  - 支持邮件附件存储。
  - 每封邮件可以有多个附件。
  - 附件存储的字段：
    - 附件 ID：自增主键。
    - 所属邮件 ID：关联邮件表的外键。
    - 附件文件名。
    - 附件文件路径。
    - 附件创建时间。

##### 1.1.3 邮件分类与关键词标记

- **标签功能**：
  - 每封邮件可添加多个标签或关键词，用于分类或快速检索。
  - 标签存储为 JSON 格式的字符串数组，例如：`["重要", "工作", "个人"]`。
  - 支持基于标签的简单查询。

---

#### 1.2 数据库设计

##### 1.2.1 数据表结构

1. **`emails` 表**
   - 用于存储邮件的主要信息。
   - 字段设计：

     | 字段名         | 数据类型          | 描述                           |
     |----------------|-------------------|--------------------------------|
     | id             | `UUID`           | 邮件主键，全球唯一标识符。      |
     | sender         | `String`         | 发件人地址。                    |
     | recipients     | `Text` (JSON)    | 收件人列表，JSON 格式。         |
     | cc             | `Text` (JSON)    | 抄送列表，JSON 格式。           |
     | bcc            | `Text` (JSON)    | 密件抄送列表，JSON 格式。       |
     | subject        | `String`         | 邮件主题。                      |
     | text_content   | `Text`           | 邮件纯文本内容。                |
     | html_content   | `Text`           | 邮件 HTML 内容。                |
     | tags           | `Text` (JSON)    | 邮件标签列表，JSON 格式。       |
     | sent_at        | `DateTime`       | 邮件发送时间。                  |
     | headers        | `Text` (JSON)    | 邮件头信息，JSON 格式。         |
     | created_at     | `DateTime`       | 创建时间。                      |
     | updated_at     | `DateTime`       | 更新时间。                      |

2. **`attachments` 表**
   - 用于存储邮件附件信息。
   - 字段设计：

     | 字段名         | 数据类型      | 描述                           |
     |----------------|---------------|--------------------------------|
     | id             | `Integer`     | 附件主键，自增。               |
     | email_id       | `UUID`        | 所属邮件 ID，外键关联。        |
     | filename       | `String`      | 附件文件名。                   |
     | filepath       | `String`      | 附件存储路径。                 |
     | created_at     | `DateTime`    | 创建时间。                     |

---

#### 1.3 系统实现细节

##### 1.3.1 邮件标签的实现

- **存储格式**：
  - 标签以 JSON 字符串形式存储在 `emails` 表的 `tags` 字段中。
  - 示例：`["重要", "工作", "会议"]`
- **操作功能**：
  - 插入新邮件时，可以直接添加标签。
  - 查询时可以基于标签字段实现关键字过滤。

##### 1.3.2 附件存储

- 附件以文件路径的形式存储在文件系统中，数据库中记录路径信息。
- 每个附件记录与 `emails` 表通过 `email_id` 建立外键关联。

---

### 2. **数据库初始化**  

- **表创建策略**：
  - 如果表已存在，需要更新，通过邮件头中的Message-ID判断邮件是否重复，重复的邮件不导入
  - 基于邮件ID或日期字段）增加索引以提升查询性能
- **初始数据**：
  - 需要一些示例数据用于测试

### 3. **数据库操作需求**  

- 除了数据插入，是否需要支持：
  - 查询（按日期范围、发件人、收件人等过滤）？
  - 更新（例如修改解析错误的数据）？
  - 删除（例如清理过旧的邮件数据）？
  - 导出（将数据库数据导出为其他格式，如CSV）？

### 4. **编码要求**  

- 是否有特殊字符处理需求（例如邮件中可能的非ASCII字符或多语言内容）？
- 日期字段是否需要特定格式（如`YYYY-MM-DD HH:MM:SS`）？

### 5. **错误处理**  

- 当插入操作失败（例如字段数据过长或冲突）时，应该如何处理？
  - 跳过问题数据并继续。
  - 记录错误日志。
  - 中止操作。

### 6. **数据库性能和安全**  

- **性能需求**：
  - 是否有大批量数据插入需求（如一次插入数百封邮件）？
  - 是否需要事务处理以保证批量操作的完整性？
- **安全需求**：
  - 是否需要对数据库访问加密或限制？
  - 是否需要为数据库连接加入超时机制？

### 7. **开发中的测试需求**  

- 是否提供测试用的EML文件及其预期解析结果？
- 是否需要设计自动化测试来验证数据库功能？

如果这些信息已经确定或需要进一步讨论，请告诉我！
